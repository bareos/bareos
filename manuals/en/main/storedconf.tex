%%
%%

\chapter{Storage Daemon Configuration}
\label{StoredConfChapter}
\index[sd]{Configuration}
\index[general]{Storage Daemon!Configuration}
\index[general]{Configuration!Storage Daemon}

The \bareosSd configuration file has relatively few resource definitions.
However, due to the great variation in backup media and system capabilities,
the storage daemon must be highly configurable. As a consequence, there are
quite a large number of directives in the Device Resource definition that
allow you to define all the characteristics of your Storage device (normally a
tape drive). Fortunately, with modern storage devices, the defaults are
sufficient, and very few directives are actually needed.

For a general discussion of configuration file and resources including the
data types recognized by {\bf Bareos}, please see the
\ilink{Configuration}{ConfigureChapter} chapter of this manual. The
following Storage Resource definitions must be defined:

\begin{itemize}
\item
   \ilink{Storage}{StorageResourceStorage} -- to define the  name of the
   Storage daemon.
\item
   \ilink{Director}{StorageResourceDirector} -- to  define the Director's
   name and his access password.
\item
   \ilink{Device}{StorageResourceDevice} -- to define  the
   characteristics of your storage device (tape  drive).
\item
   \ilink{Messages}{MessagesChapter} -- to define where error  and
   information messages are to be sent.
\end{itemize}

Following resources are optional:
\begin{itemize}
\item
   \nameref{StorageResourceAutochanger} -- to define Autochanger devices.
\item
   \nameref{StorageResourceNDMP} -- to define the NDMP authentication
   context.
\end{itemize}

\section{Storage Resource}
\label{StorageResourceStorage}
\index[sd]{Resource!Storage}
\index[sd]{Storage!Resource}

In general, the properties specified under the Storage resource define global
properties of the Storage daemon. Each Storage daemon configuration file must
have one and only one Storage resource definition.

\input{autogenerated/bareos-sd-resource-storage-table.tex}
\input{bareos-sd-resource-storage-definitions.tex}
\input{autogenerated/bareos-sd-resource-storage-description.tex}


% \begin{description}

% \item [Subsys Directory = {\textless}Directory{\textgreater}] \hfill \\
% \index[sd]{Subsys Directory}
% \index[sd]{Directive!Subsys Directory}
% This directive is currently unused.

% \end{description}

The following is a typical Storage daemon storage resource definition.

\begin{bconfig}{Storage daemon storage definition}
#
# "Global" Storage daemon configuration specifications appear
# under the Storage resource.
#
Storage {
  Name = "Storage daemon"
  Address = localhost
}
\end{bconfig}

\section{Director Resource}
\label{StorageResourceDirector}
\index[sd]{Resource!Director}
\index[sd]{Director!Resource}

The Director resource specifies the Name of the Director which is permitted
to use the services of the Storage daemon.  There may be multiple Director
resources.  The Director Name and Password must match the corresponding
values in the Director's configuration file.

\input{autogenerated/bareos-sd-resource-director-table.tex}
\input{bareos-sd-resource-director-definitions.tex}
\input{autogenerated/bareos-sd-resource-director-description.tex}

The following is an example of a valid Director resource definition:
\begin{bconfig}{Storage daemon Director definition}
Director {
  Name = MainDirector
  Password = my_secret_password
}
\end{bconfig}



\section{NDMP Resource}
\label{NDMPResource}
\label{StorageResourceNDMP}
\index[sd]{Resource!NDMP}
\index[sd]{NDMP!Resource}

The NDMP Resource specifies the authentication details of each NDMP client.
There may be multiple NDMP resources for a single Storage daemon. In general,
the properties specified within the NDMP resource are specific to one client.

\input{autogenerated/bareos-sd-resource-ndmp-table.tex}
\input{bareos-sd-resource-ndmp-definitions.tex}
\input{autogenerated/bareos-sd-resource-ndmp-description.tex}



\section{Device Resource}
\label{StorageResourceDevice}
\index[sd]{Resource!Device}
\index[sd]{Device!Resource}

The Device Resource specifies the details of each device (normally a tape
drive) that can be used by the Storage daemon.  There may be multiple
Device resources for a single Storage daemon.  In general, the properties
specified within the Device resource are specific to the Device.

\input{autogenerated/bareos-sd-resource-device-table.tex}
\input{bareos-sd-resource-device-definitions.tex}
\input{autogenerated/bareos-sd-resource-device-description.tex}


\subsection{Edit Codes for Mount and Unmount Directives}
\index[general]{Edit Codes for Mount and Unmount Directives}
\index[general]{Mount and Unmount: use variables in directives}
\label{mountcodes}

Before submitting the {\bf Mount Command}, or {\bf Unmount Command}
directives to the operating system, Bareos performs character substitution
of the following characters:

\footnotesize
\begin{verbatim}
    %% = %
    %a = Archive device name
    %e = erase (set if cannot mount and first part)
    %n = part number
    %m = mount point
    %v = last part name (i.e. filename)
\end{verbatim}
\normalsize

\subsection{Devices that require a mount (USB)}
\index[general]{Devices that require a mount (USB)}

\begin{description}
\item \linkResourceDirective{Sd}{Device}{Requires Mount}
You must set this directive to {\bf yes} for removable devices such as
USB unless they are automounted, and to {\bf no} for all other devices
(tapes/files).  This directive indicates if the device requires to be
mounted to be read, and if it must be written in a special way.  If it
set, \linkResourceDirective{Sd}{Device}{Mount Point}, 
\linkResourceDirective{Sd}{Device}{Mount Command} and 
\linkResourceDirective{Sd}{Device}{Unmount Command}
directives must also be defined.

\item \linkResourceDirective{Sd}{Device}{Mount Point}
Directory where the device can be mounted.

\item \linkResourceDirective{Sd}{Device}{Mount Command}
Command that must be executed to mount the device. Before the command is
executed, \%a is replaced with the Archive Device, and \%m with the Mount
Point.

Most frequently, you will define it as follows:

\begin{bconfig}{}
Mount Command = "/bin/mount -t iso9660 -o ro %a %m"
\end{bconfig}

For some media, you may need multiple commands.  If so, it is recommended
that you use a shell script instead of putting them all into the Mount
Command.  For example, instead of this:

\begin{bconfig}{}
Mount Command = "/usr/local/bin/mymount"
\end{bconfig}

Where that script contains:

\begin{commands}{}
#!/bin/sh
ndasadmin enable -s 1 -o w
sleep 2
mount /dev/ndas-00323794-0p1 /backup
\end{commands}

Similar consideration should be given to all other Command parameters.

\item \linkResourceDirective{Sd}{Device}{Unmount Command}
Command that must be executed to unmount the device. Before the command  is
executed, \%a is replaced with the Archive Device, and \%m with the  Mount
Point.

Most frequently, you will define it as follows:

\begin{bconfig}{}
Unmount Command = "/bin/umount %m"
\end{bconfig}

  If you need to specify multiple commands, create a shell script.

\end{description}

%% This pulls in the Autochanger resource from another file.
\input{storedconf-autochangerres}



\section{Messages Resource}
\label{MessagesResource1}
\index[general]{Resource!Messages}
\index[general]{Messages!Resource}

For a description of the Messages Resource, please see the
\nameref{MessagesChapter} chapter of this
manual.

\section{Example Storage Daemon Configuration File}
\label{ExampleStorageConfiguration}

A example Storage Daemon configuration file might be the following:

\bconfigInput{bareos-sd.conf}
