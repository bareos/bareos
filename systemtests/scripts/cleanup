#!/bin/bash
set -u

#shellcheck source=../environment.in
. ./environment

"${rscripts}/bareos" stop >/dev/null

function deletefiles(){
  rm -rf "${tmp:?}"/*
  rm -rf "${logdir:?}"/*.log
  rm -rf "${working:?}"/*.bsr "${working:?}"/log*.sd
  rm -rf "${working:?}"/*.trace "${working:?}"/*.traceback "${working:?}"/*.bactrace
  rm -rf "${working:?}"/*.state
  rm -rf "${working:?}"/*.conmsg
  rm -rf "${working:?}"/*.cryptoc || :
  rm -rf "${working:?}"/*.pid
  rm -rf "${working:?}"/*.mail
  rm -rf "${working:?}"/CLEANUPMARKER
  rm -rf "${working:?}"/plugins/*
  rm -rf "${archivedir:?}"/*
  rm -f  "${config_directory_dir_additional_test_config}"/*
  find . -name "gigaslam.gif" -exec rm -f {} \;
  # cleanup chrome user data (selenium tests)
  rm -rf /tmp/chrome-user-data-*
}
deletefiles

export asan_error=0
for prefix in ${SANITIZER_LOG_PREFIXES[@]};
do
    while read -r -d $'\0' file
    do
        echo "${file}"
        cat "${file}"
        asan_error=1
    done < <(find "$(dirname "${prefix}")" -name "$(basename "${prefix}")*" -print0)
done

deletefiles

${scripts}/drop_bareos_database ${DBTYPE} >/dev/null 2>&1

if [ ${asan_error} -ne 0 ]; then
    echo ">> Exiting with error as a sanitizer issue was detected <<"
    exit 1
fi

exit 0
