#!/bin/sh
#
# This systemtest tests the Percona plugin functionality
# of the Bareos FD by using the supplied module
#   BareosFdPluginPerconaXtraBackup.py
#
TestName="$(basename "$(pwd)")"
export TestName

JobName=backup-bareos-fd
. ./environment
. ${scripts}/functions

${scripts}/cleanup
${scripts}/setup

xtrabackup_test_db="${db_name}_xtrabackup"

start_test

echo "------ running PERCONA tests"
echo "drop database ${xtrabackup_test_db}" | mysql
echo "create database ${xtrabackup_test_db}" | mysql
echo "CREATE TABLE test ( id INT NOT NULL PRIMARY KEY AUTO_INCREMENT, data VARCHAR(100), created TIMESTAMP DEFAULT NOW())  " | mysql ${xtrabackup_test_db}
echo "insert into test (data) VALUES ('test entry 1') " | mysql ${xtrabackup_test_db}


BCONSOLE="${current_test_directory}/bin/bconsole"

run_bareos

echo "@$out $tmp/log1.out"  | $BCONSOLE

COMMAND="run job=$JobName"
echo -e "$COMMAND \ryes\rwait" | $BCONSOLE #| grep "Job queued. JobId="
#sleep 5
echo -e "wait JobName=$JobName" | $BCONSOLE
#sleep 2
echo "status dir" | $BCONSOLE
# insert data and run incremental
echo "insert into test (data) VALUES ('test entry 2') " | mysql ${xtrabackup_test_db}

COMMAND="$COMMAND level=Incremental"
echo -e "$COMMAND \ryes\rwait" | $BCONSOLE #| grep "Job queued. JobId="
#sleep 5
echo -e "wait JobName=$JobName" | $BCONSOLE
#sleep 2
echo "status dir" | $BCONSOLE


# run incremental again without any new data
echo -e "$COMMAND \ryes\rwait" | $BCONSOLE #| grep "Job queued. JobId="
#sleep 5
echo -e "wait JobName=$JobName" | $BCONSOLE
#sleep 2
echo "status dir" | $BCONSOLE


# run restore
RESTORECMD="restore client=bareos-fd fileset=PerconaXtraBackupTest yes restorejob=RestoreFile select all\rdone\r"

echo "@$out $tmp/log2.out"  | $BCONSOLE

JOBID=`echo -e "$RESTORECMD" | $BCONSOLE | grep "Job queued. JobId=" | sed s'/.*=//' `

echo -e "wait jobid=$JOBID" | $BCONSOLE | grep -q "JobStatus=OK"
if [[ $? != 0 ]]; then
    echo "Restore Job $JOBID failed"
    estat=1
fi

# Check, if xtrabackup has extracted some files at least
# TODO: verify that xtrabackup --prepare works and eventually do complete datbase restore
ls -lR  $tmp/bareos-restores/_percona/
if [ -z "$(ls -A $tmp/bareos-restores/_percona/)" ]; then
       echo "No restore data found"
       estat=1
fi





check_for_zombie_jobs storage=File
stop_bareos

check_two_logs

end_test
