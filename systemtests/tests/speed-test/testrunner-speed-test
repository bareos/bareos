#!/bin/bash

set -e
set -o pipefail
set -u

TestName="$(basename "$(pwd)")"
export TestName

#shellcheck source=../environment.in
. ./environment

#shellcheck source=../scripts/functions
. "${rscripts}"/functions

source "defs"

bin/bareos stop
bin/bareos start




start_test

backup_log="$tmp"/backups.out
restore_log="$tmp"/restores.out
consolidate_log="$tmp"/consolidate.out
output="$tmp/output.csv"

rm -rf "$backup_log" "$consolidate_log" "$output"

echo  "Test;backup;restore" > "$output"

for filesetoptions in "${FilesetOptions[@]}"; do

  rm storage/* ||:

  echo $filesetoptions > include/etc/bareos/bareos-dir.d/fileset/default.conf
  filesetoptions_filenamecompat=$(tr ',=' '_' <<< $filesetoptions)
	log="$backup_log-$filesetoptions_filenamecompat"
  echo > "$log"
	cat <<END_OF_DATA >"$tmp/bconcmds"
@$out /dev/null
messages
@$out $log
reload
show fileset=Default
run job=backup-bareos-fd level=Full yes
wait
messages
END_OF_DATA
cat "$tmp/bconcmds"
	run_bconsole

	expect_grep "Backup OK" \
		    "$log" \
		    "Backup was not ok."
  ToAdd=$(grep -o "[0-9.]* KB/s" "$log")
	echo "... result: $ToAdd"
	#Data+=("$ToAdd")
  echo  -n  "$filesetoptions;$ToAdd;"  >> "$output"

# now restore
	log="$restore_log-$filesetoptions_filenamecompat"
  echo > "$log"
  # clean restore dir
  sudo rm -Rvf "$tmp/bareos-restores"
  cat <<END_OF_DATA >"$tmp/bconcmds"
@$out /dev/null
messages
@$out $log
reload
restore client=bareos-fd where=$tmp/bareos-restores select all done yes
wait
messages
END_OF_DATA
	run_bconsole
	expect_grep "Restore OK" \
		    "$log" \
		    "Restore was not ok."
  ToAdd=$(grep -o "[0-9.]* KB/s" "$log")
	echo "... result: $ToAdd"
  echo  "$ToAdd"  >> "$output"
done

printf "\n\nResults:\n------\n"
column -t -s, "${output}"

end_test
